services:
  # 1. Redis: 데이터 저장소
  redis:
    image: redis:alpine
    container_name: mobility-redis
    ports:
      - "6379:6379"
    restart: always

  # 2. Kafka: 메시지 브로커 (Apache 공식 이미지 설정)
  kafka:
    image: apache/kafka:latest
    container_name: mobility-kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
    restart: always

  # 3. Query API: 조회 서버
  query-api:
    build: .
    container_name: mobility-query-api
    ports:
      - "8000:8000"
    environment:
      - REDIS_HOST=redis
      - KAFKA_BOOTSTRAP=kafka:9092
      - QUERY_API_PORT=8000
    depends_on:
      - redis
      - kafka
    restart: always

  # 4. Query Consumer: Kafka 구독기
  query-consumer:
    build: .
    container_name: mobility-query-consumer
    command: python consumer.py
    environment:
      - REDIS_HOST=redis
      - KAFKA_BOOTSTRAP=kafka:9092
    depends_on:
      - redis
      - kafka
    restart: on-failure # 실패 시 자동 재시작